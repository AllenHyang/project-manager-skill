# /pm:task:check - 检查任务质量

智能检查任务的完备性和清晰度，确保任务符合项目规范。

## 用法

```bash
# 检查指定任务
/pm:task:check 123

# 检查当前活动任务
/pm:task:check

# 严格模式（所有警告都视为错误）
/pm:task:check 123 --strict

# 只显示问题，不显示通过的项
/pm:task:check 123 --issues-only
```

## AI 会做什么

1. **加载任务信息**
   - 从 `.project-log/tasks/tasks.json` 或任务文件获取信息
   - 提取任务的标题、描述、优先级、标签等

2. **读取项目规则**
   - 读取 `.task-context.md` - 最新的临时规则和关注点
   - 读取 `.pm/task-rules.yaml` - 项目的稳定规则
   - 这两个文件的规则会被优先应用

3. **智能质量分析**
   - 遵循 `~/.claude/skills/project-manager/prompts/task-quality-gate.md` 的指导
   - 对 6 个维度进行智能评估（每个 0-10 分）：
     1. 基础完整性
     2. 目的清晰度
     3. 类型匹配度
     4. 验收标准
     5. 项目规则符合性
     6. 最新关注点符合性

4. **生成质量报告**
   - 详细的评分和说明
   - 具体的问题和改进建议
   - 可操作的命令和步骤
   - 总体评级（优秀/良好/及格/不合格）

## 检查维度说明

### 1. 基础完整性 (10 分)
检查任务的基本信息是否完整：
- 标题格式、长度
- 描述内容
- 优先级设置
- 标签设置

### 2. 目的清晰度 (10 分)
评估任务的目的是否清晰：
- 为什么要做这个任务（背景）
- 期望达到什么结果（目标）
- 是否有歧义或模糊之处

### 3. 类型匹配度 (10 分)
根据任务类型，检查是否包含必需信息：
- Bug: 复现步骤、错误日志、影响范围
- Feature: 功能需求、技术方案、影响范围
- Performance: 基准数据、优化目标、验证方法
- Test: 测试场景、数据准备、清理步骤

### 4. 验收标准 (10 分)
检查验收标准的质量：
- 是否有明确的验收标准
- 标准是否可验证（具体指标）
- 是否包含测试要求

### 5. 项目规则符合性 (10 分)
根据任务标签，检查是否符合项目特定规则：
- E2E 测试规则
- 邮件功能规则
- 同步功能规则
- 数据库改动规则
- 等等（见 `.pm/task-rules.yaml`）

### 6. 最新关注点符合性 (10 分)
检查是否考虑了当前的关注点：
- 本周关注点
- 最近发现的问题
- 临时注意事项
（见 `.task-context.md`）

## 输出示例

```
🔍 任务质量检查报告

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
任务信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

任务 ID: #123
标题: [Bug] 修复邮件同步超时问题
类型: Bug
优先级: high
标签: bug, sync, email

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
评分详情 (总分 60)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 基础完整性: 9/10
  ✓ 标题格式良好：[Bug] 修复邮件同步超时问题
  ✓ 有详细描述
  ✓ 优先级已设置：high
  ✓ 标签完整：bug, sync, email
  ⚠️ 建议：标题可以更具体，如说明在什么场景下超时

⚠️ 目的清晰度: 7/10
  ✓ 问题现象描述清楚："大量邮件时同步超时"
  ✓ 有背景说明
  ⚠️ 缺少：具体的数据量阈值（多少封邮件算"大量"）
  ⚠️ 建议补充：当前超时时间和期望时间

⚠️ 类型匹配度: 6/10 (Bug 任务)
  ✓ 有问题描述
  ✓ 有影响范围说明
  ✗ 缺少：复现步骤（如何触发超时）
  ✗ 缺少：错误日志或截图

✅ 验收标准: 8/10
  ✓ 有明确的验收标准
  ✓ 包含测试要求
  ⚠️ 可以更具体：改为"1000 封邮件场景下同步时间 < 30s"

✅ 项目规则符合性: 10/10
  适用规则：邮件功能、同步功能
  ✓ 考虑了多账户场景
  ✓ 包含性能测试计划
  ✓ 符合邮件功能的所有要求

⚠️ 最新关注点: 8/10
  参考：.task-context.md
  ✓ 符合"本周关注点"
  ⚠️ 建议关注：测试后记得清理数据

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总体评估
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 总分: 48/60

🟡 良好 (40-49)
主要内容完整，建议完善细节后再开始

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
改进建议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 必需改进（影响任务质量）:

1. 添加复现步骤
   问题: Bug 任务缺少复现步骤
   建议: 说明如何触发超时（账户设置、邮件数量、操作步骤）
   操作: pm task update 123 --description "$(cat <<EOF
   [当前描述...]

   **复现步骤**：
   1. 创建测试账户，导入 1000+ 封邮件
   2. 触发全量同步
   3. 观察同步时间
   EOF
   )"

2. 添加错误日志
   问题: 缺少错误日志或截图
   建议: 添加完整的错误日志或超时的截图
   操作: 将日志内容添加到任务描述的"错误信息"部分

⚠️ 建议改进（提升任务质量）:

3. 具体化验收标准
   问题: 验收标准不够具体
   建议: 明确具体的性能指标
   改为: "在 1000 封邮件场景下，同步时间从当前 60s 降至 < 30s"

4. 补充数据量说明
   问题: "大量邮件"的定义不明确
   建议: 说明具体的邮件数量阈值

💡 可选优化（锦上添花）:

5. 添加相关 Issue 链接
   如果有 GitHub Issue，添加链接方便追溯

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
最终结论
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 建议完善后再开始

任务主要内容完整，但缺少一些关键信息（复现步骤、错误日志）。
建议先补充这些信息，可以提高开发效率，避免后续反复确认。

选项:
1. 完善任务描述后再启动（推荐）
2. 使用 /pm:task:start 123 --skip-checks 强制开始（不推荐）
3. 需要帮助完善描述？我可以协助
```

## 质量等级说明

- **🟢 优秀 (50-60 分)**
  - 所有维度得分良好
  - 信息完整且清晰
  - 可以直接开始任务

- **🟡 良好 (40-49 分)**
  - 主要内容完整
  - 有一些可改进之处
  - 建议完善细节后再开始

- **🟠 及格 (30-39 分)**
  - 基本信息存在
  - 有明显缺失
  - 建议改进后再开始

- **🔴 不合格 (<30 分)**
  - 缺少关键信息
  - 目的不清晰
  - 强烈建议完善后再开始

## 使用场景

### 1. 创建任务后验证
```
你: 创建任务：修复邮件同步bug
AI: [创建任务 #123]
你: /pm:task:check 123
AI: [执行质量检查，给出报告]
```

### 2. 启动任务前检查
```
你: /pm:task:check 123
AI: [质量报告] 🟡 良好，建议完善...
你: [完善任务描述]
你: /pm:task:start 123
AI: [再次检查] 🟢 优秀，开始任务！
```

### 3. 任务更新后验证
```
你: pm task update 123 --description "..."
你: /pm:task:check 123
AI: [检查更新是否充分]
```

### 4. 定期任务审查
```
你: /pm:task:check 123
AI: [检查任务是否仍然符合最新规则]
```

## 自然语言触发

用户也可以用自然语言：
- "检查任务 123"
- "验证一下任务 123"
- "任务 123 的质量怎么样"
- "这个任务可以开始了吗"
- "看看任务 123 有什么问题"

## 与其他命令的关系

- **`/pm:task:start`** - 会自动执行此检查
- **`/pm:task:check`** - 可以独立使用，随时检查
- **`/pm:task:update`** - 更新后可以用此命令验证

## 相关命令

- `/pm:task:start` - 启动任务（包含自动检查）
- `/pm:task:update` - 更新任务信息
- `/pm:task:show` - 查看任务详情

## 提示

💡 检查是基于 AI 智能分析，而不是硬编码规则。这意味着：
- 更灵活、更智能
- 能理解上下文和意图
- 能给出具体、可操作的建议
- 会考虑项目历史和最新发现

📚 检查依据：
- `~/.claude/skills/project-manager/prompts/task-quality-gate.md` - 检查框架
- `.task-context.md` - 最新规则和关注点
- `.pm/task-rules.yaml` - 项目稳定规则
